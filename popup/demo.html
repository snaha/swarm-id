<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Swarm ID Login Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h1 {
        color: white;
        text-align: center;
        font-size: 42px;
        margin-bottom: 10px;
        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
      }

      .subtitle {
        color: rgba(255,255,255,0.95);
        text-align: center;
        font-size: 18px;
        margin-bottom: 30px;
      }

      .main-panel {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        margin-bottom: 20px;
      }

      .auth-section {
        border-bottom: 2px solid #f093fb;
        padding-bottom: 30px;
        margin-bottom: 30px;
      }

      .auth-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
      }

      .status-indicator {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 18px;
        font-weight: 600;
      }

      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
      }

      .status-dot.authenticated {
        background: #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      }

      .status-dot.unauthenticated {
        background: #dc3545;
      }

      .login-button {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .login-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(245, 87, 108, 0.5);
      }

      .login-button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      h2 {
        color: #f5576c;
        font-size: 24px;
        margin-bottom: 20px;
      }

      .test-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .test-controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 20px;
      }

      .test-input {
        grid-column: 1 / -1;
      }

      textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
      }

      input[type="text"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
      }

      button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .output-box {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
        margin-top: 15px;
      }

      .output-box pre {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .info-panel {
        background: #e7f3ff;
        border: 2px solid #2196F3;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .info-panel h3 {
        color: #1565C0;
        margin-bottom: 15px;
      }

      .info-panel p {
        color: #333;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .info-panel ul {
        margin-left: 20px;
        color: #333;
        line-height: 1.8;
      }

      code {
        background: #f4f4f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
      }

      .iframe-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        margin-bottom: 20px;
      }

      .iframe-container iframe {
        width: 100%;
        height: 80px;
        border: 2px solid #f093fb;
        border-radius: 8px;
      }

      .success-message {
        color: #28a745;
        font-weight: 600;
      }

      .error-message {
        color: #dc3545;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîê Swarm ID Login Demo</h1>
      <p class="subtitle">Secure cross-origin authentication with iframe + popup</p>

      <div class="info-panel">
        <h3>‚ÑπÔ∏è How This Works</h3>
        <p>
          This demo shows the OAuth-style authentication flow that works across all browsers
          (including Safari) without requiring Storage Access API.
        </p>
        <ul>
          <li><strong>Step 1:</strong> Click "Login with Swarm ID" to open authentication popup</li>
          <li><strong>Step 2:</strong> Popup accesses master identity from first-party localStorage (no partitioning)</li>
          <li><strong>Step 3:</strong> Popup derives app-specific secret and sends to hidden iframe</li>
          <li><strong>Step 4:</strong> Iframe stores secret in partitioned localStorage</li>
          <li><strong>Step 5:</strong> All Bee API calls go through iframe, which adds secret</li>
        </ul>
      </div>

      <div class="main-panel">
        <!-- Authentication Section -->
        <div class="auth-section">
          <h2>Authentication</h2>
          <div class="iframe-container">
            <iframe
              id="proxy-iframe"
              src="https://swarm-id.local:8081/popup/proxy.html"
              title="Swarm ID Proxy"
            ></iframe>
          </div>
        </div>

        <!-- Upload Test Section -->
        <div class="test-section">
          <h2>Upload Chunk</h2>
          <div class="test-controls">
            <div class="test-input">
              <textarea
                id="upload-data"
                placeholder="Enter text to upload..."
              >Hello from Swarm ID demo!</textarea>
            </div>
            <button onclick="uploadChunk()" id="upload-button" disabled>
              ‚¨ÜÔ∏è Upload Chunk
            </button>
            <button onclick="runUploadDownloadTest()" id="test-button" disabled>
              üß™ Run Upload + Download Test
            </button>
          </div>
          <div class="output-box" id="upload-output">
            <pre>Output will appear here...</pre>
          </div>
        </div>

        <!-- Download Test Section -->
        <div class="test-section">
          <h2>Download Chunk</h2>
          <div class="test-controls">
            <div class="test-input">
              <input
                type="text"
                id="download-reference"
                placeholder="Enter chunk reference (hash)..."
              />
            </div>
            <button onclick="downloadChunk()" id="download-button" disabled>
              ‚¨áÔ∏è Download Chunk
            </button>
          </div>
          <div class="output-box" id="download-output">
            <pre>Output will appear here...</pre>
          </div>
        </div>
      </div>

    </div>

    <script type="module">
      /**
       * Swarm ID Demo App
       *
       * Demonstrates the OAuth-style login flow with:
       * 1. Authentication via popup window
       * 2. Hidden iframe proxy for Bee API calls
       * 3. App-specific secret storage in partitioned localStorage
       */

      const PROXY_ORIGIN = 'https://swarm-id.local:8081';
      const AUTH_POPUP_URL = `${PROXY_ORIGIN}/connect`;

      let proxyIframe = null;
      let authenticated = false;
      let messageId = 0;
      let pendingRequests = new Map();

      // Get iframe reference
      proxyIframe = document.getElementById('proxy-iframe');

      // Send identification message when iframe loads
      proxyIframe.addEventListener('load', () => {
        console.log('[Demo] Iframe loaded, sending identification...');

        // Send parentIdentify message
        proxyIframe.contentWindow.postMessage(
          { type: 'parentIdentify' },
          PROXY_ORIGIN
        );
      });

      // Send message to proxy iframe
      function sendToProxy(message) {
        return new Promise((resolve, reject) => {
          const requestId = `msg-${++messageId}`;
          message.requestId = requestId;

          // Store promise handlers
          pendingRequests.set(requestId, { resolve, reject });

          // Set timeout
          const timeout = setTimeout(() => {
            pendingRequests.delete(requestId);
            reject(new Error('Request timeout'));
          }, 10000);

          // Clear timeout when resolved
          const originalResolve = resolve;
          const wrappedResolve = (value) => {
            clearTimeout(timeout);
            originalResolve(value);
          };

          pendingRequests.set(requestId, { resolve: wrappedResolve, reject });

          // Send message
          proxyIframe.contentWindow.postMessage(message, PROXY_ORIGIN);
          console.log('[Demo] Sent to proxy:', message.type);
        });
      }

      // Listen for messages from proxy iframe
      window.addEventListener('message', (event) => {
        // Validate origin from proxy iframe
        if (event.origin !== PROXY_ORIGIN) {
          console.warn('[Demo] Rejected message from unauthorized origin:', event.origin);
          return;
        }

        const { type, requestId, ...data } = event.data;
        console.log('[Demo] Received from proxy:', type);

        // Handle proxy ready acknowledgment
        if (type === 'proxyReady') {
          console.log('[Demo] Proxy acknowledged parent identification');
          console.log('[Demo] Parent origin verified as:', data.parentOrigin);
          // Now we can check auth status
          checkAuthStatus();
          return;
        }

        // Handle responses with requestId
        if (requestId && pendingRequests.has(requestId)) {
          const { resolve, reject } = pendingRequests.get(requestId);
          pendingRequests.delete(requestId);

          if (type === 'error') {
            reject(new Error(data.error));
          } else {
            resolve(data);
          }
          return;
        }

        // Handle notifications (no requestId)
        switch (type) {
          case 'proxyReady':
            console.log('[Demo] Proxy iframe ready');
            checkAuthStatus();
            break;

          case 'authSuccess':
            console.log('[Demo] Authentication successful!');
            authenticated = true;
            updateAuthStatus();
            break;

          default:
            console.log('[Demo] Unhandled message type:', type);
        }
      });

      // Check authentication status
      async function checkAuthStatus() {
        console.log('[Demo] Checking authentication status...');
        updateAuthStatus(false, 'Checking...');

        try {
          const response = await sendToProxy({ type: 'checkAuth' });
          authenticated = response.authenticated;
          console.log('[Demo] Authentication status:', authenticated);
          updateAuthStatus();
        } catch (error) {
          console.error('[Demo] Failed to check auth status:', error);
          updateAuthStatus(false, 'Error checking status');
        }
      }

      // Update authentication UI
      function updateAuthStatus(isAuth = authenticated, text = null) {
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('auth-status-text');
        const loginButton = document.getElementById('login-button');
        const uploadButton = document.getElementById('upload-button');
        const downloadButton = document.getElementById('download-button');
        const testButton = document.getElementById('test-button');

        if (isAuth) {
          statusDot.className = 'status-dot authenticated';
          statusText.textContent = text || 'Authenticated ‚úì';
          statusText.style.color = '#28a745';
          loginButton.style.display = 'none';
          uploadButton.disabled = false;
          downloadButton.disabled = false;
          testButton.disabled = false;
        } else {
          statusDot.className = 'status-dot unauthenticated';
          statusText.textContent = text || 'Not authenticated';
          statusText.style.color = '#dc3545';
          loginButton.style.display = 'block';
          uploadButton.disabled = true;
          downloadButton.disabled = true;
          testButton.disabled = true;
        }
      }

      // Login with Swarm ID
      window.loginWithSwarmId = function() {
        console.log('[Demo] Requesting authentication from iframe...');

        // Ask iframe to open auth popup
        proxyIframe.contentWindow.postMessage(
          { type: 'requestAuth' },
          PROXY_ORIGIN
        );

        console.log('[Demo] Auth request sent to iframe');
      };

      // Upload chunk
      window.uploadChunk = async function() {
        const textarea = document.getElementById('upload-data');
        const output = document.getElementById('upload-output');
        const button = document.getElementById('upload-button');

        const text = textarea.value;
        if (!text) {
          output.innerHTML = '<pre class="error-message">Please enter some text to upload</pre>';
          return;
        }

        button.disabled = true;
        output.innerHTML = '<pre>Uploading chunk...</pre>';

        try {
          // Convert text to Uint8Array
          const encoder = new TextEncoder();
          const data = encoder.encode(text);

          console.log('[Demo] Uploading chunk, size:', data.length);

          // Send to proxy
          const response = await sendToProxy({
            type: 'uploadChunk',
            data: Array.from(data)
          });

          console.log('[Demo] Upload response:', response);

          output.innerHTML = `<pre class="success-message">‚úì Chunk uploaded!

Reference: ${response.reference}

Size: ${data.length} bytes

Copy the reference to download this chunk.</pre>`;

          // Auto-fill download input
          document.getElementById('download-reference').value = response.reference;

        } catch (error) {
          console.error('[Demo] Upload failed:', error);
          output.innerHTML = `<pre class="error-message">‚úó Upload failed: ${error.message}</pre>`;
        } finally {
          button.disabled = false;
        }
      };

      // Download chunk
      window.downloadChunk = async function() {
        const input = document.getElementById('download-reference');
        const output = document.getElementById('download-output');
        const button = document.getElementById('download-button');

        const reference = input.value.trim();
        if (!reference) {
          output.innerHTML = '<pre class="error-message">Please enter a chunk reference</pre>';
          return;
        }

        button.disabled = true;
        output.innerHTML = '<pre>Downloading chunk...</pre>';

        try {
          console.log('[Demo] Downloading chunk:', reference);

          // Send to proxy
          const response = await sendToProxy({
            type: 'downloadChunk',
            reference: reference
          });

          console.log('[Demo] Download response:', response);

          // Convert data back to text
          const decoder = new TextDecoder();
          const uint8Data = new Uint8Array(response.data);
          const text = decoder.decode(uint8Data);

          output.innerHTML = `<pre class="success-message">‚úì Chunk downloaded!

Reference: ${reference}

Size: ${response.data.length} bytes

Data:
${text}</pre>`;

        } catch (error) {
          console.error('[Demo] Download failed:', error);
          output.innerHTML = `<pre class="error-message">‚úó Download failed: ${error.message}</pre>`;
        } finally {
          button.disabled = false;
        }
      };

      // Run upload + download test
      window.runUploadDownloadTest = async function() {
        const uploadOutput = document.getElementById('upload-output');
        const downloadOutput = document.getElementById('download-output');
        const button = document.getElementById('test-button');

        button.disabled = true;
        uploadOutput.innerHTML = '<pre>Running test...</pre>';
        downloadOutput.innerHTML = '<pre>Waiting for upload...</pre>';

        try {
          // Upload
          const testData = `Test data - ${Date.now()}`;
          const encoder = new TextEncoder();
          const data = encoder.encode(testData);

          console.log('[Demo] Test: Uploading...');
          const uploadResponse = await sendToProxy({
            type: 'uploadChunk',
            data: Array.from(data)
          });

          uploadOutput.innerHTML = `<pre class="success-message">‚úì Upload successful!

Reference: ${uploadResponse.reference}</pre>`;

          // Download
          console.log('[Demo] Test: Downloading...');
          downloadOutput.innerHTML = '<pre>Downloading...</pre>';

          const downloadResponse = await sendToProxy({
            type: 'downloadChunk',
            reference: uploadResponse.reference
          });

          // Verify data
          const decoder = new TextDecoder();
          const downloadedText = decoder.decode(new Uint8Array(downloadResponse.data));
          const matches = downloadedText === testData;

          downloadOutput.innerHTML = `<pre class="${matches ? 'success-message' : 'error-message'}">‚úì Download successful!

Data matches: ${matches ? 'YES ‚úì' : 'NO ‚úó'}

Original: ${testData}
Downloaded: ${downloadedText}</pre>`;

        } catch (error) {
          console.error('[Demo] Test failed:', error);
          uploadOutput.innerHTML = `<pre class="error-message">‚úó Test failed: ${error.message}</pre>`;
        } finally {
          button.disabled = false;
        }
      };

      // Initialize
      console.log('[Demo] Swarm ID demo loaded');
      console.log('[Demo] Origin:', window.location.origin);
    </script>
  </body>
</html>
